<template>

    <div class="">
        <navbar_monitoreo />
    </div>

    <div>   <!--   titulo control manual   -->
        <section>
            <div style="text-align: center;">
                <h2 class="divider-style">
                    <span>Control Manual </span>
                </h2>
            </div>
        </section>
    </div>

    <section>
        <nav class="navbar navbar-expand-md bg-body py-3">
            <div class="container">
                    <div class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navcol-5" >
                        <div class="container">
                            <div class="row bg-body py-3">
                                <div class="col-md-10" style="padding: 0px 0px;">
                                    <svg class="bi bi-arrow-left-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 40px;margin: 5px;">
                                        <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z"></path>
                                    </svg>      
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-2">
                                    <svg class="bi bi-arrow-up-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 40px;padding: 0%;">
                                        <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707z"></path>
                                    </svg>
                                </div>
                                <div class="col-md-2">
                                    <svg class="bi bi-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 40px;margin: 5px;">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"></path>
                                    </svg>
                                </div>
                                <div class="col-md-2">
                                    <svg class="bi bi-arrow-down-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 40px;padding: 0%;;margin-top: 5px;margin-bottom: 5px;">
                                        <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293z"></path>
                                    </svg>
                                    
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3" style="padding: 0px 0px;">
                                    <svg class="bi bi-arrow-right-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 40px;margin: 5px;">
                                        <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5z"></path>
                                    </svg>
                                    
                                </div>
                            </div>
                            
                            
                        </div>
                    </div>
                <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navcol-5">
                    <svg class="bi bi-justify" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 50px;padding: 0%;margin-left: 40%;margin-top: 5px;margin-bottom: 5px;">
                    <path fill-rule="evenodd" d="M2 12.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"></path>
                    </svg>
                </button>
                <div id="navcol-3" class="collapse navbar-collapse">
                    <div>
                        <div class="row">
                            <div class="col-md-10" style="padding: 0px 0px;"><svg class="bi bi-arrow-up-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 50px;padding: 0%;margin-left: 0%;margin-top: 10px;margin-bottom: 5px;">
                                    <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707z"></path>
                                </svg></div>
                        </div>
                        <div class="row">
                            <div class="col-md-3"><svg class="bi bi-arrow-left-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 50px;margin: 3px;">
                                    <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z"></path>
                                </svg></div>
                            <div class="col-md-3"><svg class="bi bi-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 50px;margin: 3px;">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"></path>
                                </svg></div>
                            <div class="col-md-3"><svg class="bi bi-arrow-right-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 50px;margin: 3px;">
                                    <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5z"></path>
                                </svg></div>
                        </div>
                        <div class="row">
                            <div class="col-md-10" style="padding: 0px 0px;">
                                <svg class="bi bi-arrow-down-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 50px; padding: 0%; margin-left: 0%; margin-top: 5px;margin-bottom: 5px;">
                                    <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <ul class="navbar-nav mx-auto">
                        <li class="nav-item"><a class="nav-link active" href="#" style="margin-top: 11px;">Plantar</a></li>
                        <li class="nav-item"><a class="nav-link active" href="#"><svg class="bi bi-play-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 50px;">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"></path>
                                    <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445"></path>
                                </svg></a></li>
                        <li class="nav-item"><a class="nav-link active" href="#" style="margin-top: 11px;">Regar</a></li>
                        <li class="nav-item"><a class="nav-link active" href="#"><svg class="bi bi-play-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 50px;">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"></path>
                                    <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445"></path>
                                </svg></a></li>
                        <li class="nav-item"><a class="nav-link active" href="#" style="margin-top: 11px;">Detener</a></li>
                        <li class="nav-item"><a class="nav-link active" href="#"><svg class="bi bi-play-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 50px;">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"></path>
                                    <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445"></path>
                                </svg></a></li>
                        <li class="nav-item"><a class="nav-link active" href="#" style="margin-top: 11px;">Censar</a></li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <svg class="bi bi-play-circle" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="font-size: 50px;">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"></path>
                                    <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445"></path>
                                </svg>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                               <button @click="enviarMensajeMQTT">Enviar Mensaje MQTT</button> 
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </section>


    <div>
        <trasmisionVue />
    </div>

    <br>

    <section>
        <div class="row">
            <div class="col">
                <div class="container">
                    <div class="row">
                        <div class="col-xxl-4" style="flex: 0 0 auto !important; width: 469px !important;">
                            <div style="text-align: center;">
                                <h2 class="divider-style"><span>Sensores</span></h2>
                            </div>
                            
                            <ul class="list-group">
                                <li class="list-group-item" style="background: var(--bs-body-bg);"><span>Planta # {{ this.posicionPlanta }}</span></li>
                                <li class="list-group-item"><span>Humedad: 50%</span></li>
                                <li class="list-group-item"><span>Temperatura: 25°C</span></li>
                                <li class="list-group-item"><span>Otro dato</span></li>
                            </ul>
                            <div style="text-align: center;">
                                <h2 class="divider-style"><span>Ambiente</span></h2>
                            </div>
                            <ul class="list-group">
                                <li class="list-group-item" style="background: var(--bs-body-bg);"><span>Humedad: {{this.humedad}}%</span></li>
                                <li class="list-group-item" style="background: var(--bs-body-bg);"><span>Temperatura: {{this.temperatura}}°C</span></li>
                                <li class="list-group-item" style="background: var(--bs-body-bg);"><span>Presión: {{this.presion}}</span></li>
                            </ul>
                            <div style="text-align: center;">
                                <h2 class="divider-style"><span>Giroscopio efector</span></h2>
                            </div>
                            <ul class="list-group">
                                <li class="list-group-item" style="background: var(--bs-body-bg);"><span>roll: {{this.giroscopio_pitch}}°</span></li>
                                <li class="list-group-item" style="background: var(--bs-body-bg);"><span>Pitch: {{this.giroscopio_roll}}°</span></li>
                                <li class="list-group-item" style="background: var(--bs-body-bg);"><span>yaw: {{this.giroscopio_yaw}}°</span></li>
                            </ul>
                        </div>
                        <div class="col-12 col-xl-6">
                            <h1 class="text-center mb-4">Distribución del cultivo</h1>
                            <table class="table">
                                <tbody>
                                    <tr v-for="(fila, filaIndex) in matriz" :key="filaIndex">
                                        <td v-for="(planta, columnaIndex) in fila" :key="columnaIndex" class="position-relative" @click="seleccionarPlanta(filaIndex, columnaIndex)"  :style="{ backgroundColor: plantaSeleccionada && filaIndex === plantaSeleccionada.fila && columnaIndex === plantaSeleccionada.columna ? 'rgb(178,218,250, 0.5)' : '' }">
                                            <div class="text-center">
                                                <p v-if="planta">{{ planta.nombre }}</p>
                                                <img v-if="planta" :src="planta.cultivo.iconosPlantas" alt="Imagen de planta" width="40" height="40">
                                                <p v-else>{{ obtenerContadorPosicion(filaIndex, columnaIndex) }}
                                                <img src="@/assets/iconos/sin_imagen.png" alt="Sin imagen de planta" width="40" height="40"></p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div>
        <listCultivo />
    </div>
    

    <section>
        <footer_imacuna />
    </section>
   

</template>



<script>
import axios from 'axios'
import navbar_monitoreo from '/src/components/agrocablebot/base.vue'
import trasmisionVue from '/src/components/agrocablebot/trasmision.vue'
import listCultivo from '/src/components/agrocablebot/monitoreo/ListCultivo.vue'
import footer_imacuna from '/src/components/footer.vue'


export default{
    components:{
        navbar_monitoreo,
        trasmisionVue, 
        listCultivo,
        footer_imacuna,
        
    },

    data(){

      return{
        'api': `${process.env.VUE_APP_API_URL}`,
        tipo_cultivo:[],
        cultivos:[],
        plantas:[],
        matriz: [],
        Datos_sensores: [],
        plantaSeleccionada: null,
        cultivoSeleccionado:null, 
        posicionPlanta:null,
        
      }
    },

    mounted(){
        this.obtenerDatosSensores();
        // Realizar las solicitudes HTTP para obtener datos
        //Lectura tipo de cultivo
        axios.get(this.api + 'api/tipoCultivo')
        .then(response =>{
            // console.log("Tipo de cultivos")
            // console.log(response.data)
            this.tipo_cultivo=response.data
        })
        .catch(error =>{
            console.log(error)
        })
        //Lectura de cultivo
        axios.get( this.api + '/api/cultivo')
        .then(response =>{
            // console.log("Cultivos")
            // console.log(response.data)
            this.cultivos=response.data
            
        })
        .catch(error =>{
            console.log(error)
        })
        //Lectura de plantas
        axios.get( this.api + '/api/plantas')
        .then(response =>{
            // console.log("plantas")
            // console.log(response.data)
            this.plantas=response.data
            this.initializeMatriz()
        })
        .catch(error =>{
            console.log(error)
        })
      
    },

    methods: {
        // Función para inicializar la matriz con los datos de las plantas
        initializeMatriz() {
            for (let i = 0; i < 9; i++) {
            this.matriz.push(new Array(9).fill(null));
            }

            // Asignar las plantas a la matriz según el número de planta asignado
            this.plantas.forEach(planta => {
            const fila = Math.floor((planta.numeroPlanta - 1) / 9);
            const columna = (planta.numeroPlanta - 1) % 9;
            this.matriz[fila][columna] = planta;  
            }); 
        },
        

        obtenerContadorPosicion(filaIndex, columnaIndex) {
            // Calcula el contador de posición basado en los índices de fila y columna
            return filaIndex * this.matriz[0].length + columnaIndex + 1;
        },
        // Seleccion de la planta mediante click y despliegue de informacion
        seleccionarPlanta(filaIndex, columnaIndex) {
            this.plantaSeleccionada = { fila: filaIndex, columna: columnaIndex };
            //console.log("Planta seleccionada", this.plantaSeleccionada)
            const planta = this.matriz[filaIndex][columnaIndex];
            this.cultivoSeleccionado = planta ? planta.cultivo : null;
            this.posicionPlanta =filaIndex * this.matriz[0].length + columnaIndex + 1;
            //console.log("posicion", posicion)
        },

        //  ---------- metodos de sensores----------------

        obtenerDatosSensores() {
            axios.get(this.api + '/api/Sensor_MQTT/')
            .then(response => {
                this.Datos_sensores=response.data
                this.obtenerUltimaActualizacion();
                // console.log(this.Datos_sensores)
            })
            .catch(error => {
                console.error('Error al obtener los datos de los sensores:', error);
            });
        },
        obtenerUltimaActualizacion() {
            // Ordenar los datos por timestamp de forma descendente para obtener la última actualización primero
            const ultimaActualizacion = this.Datos_sensores.sort((a, b) => b.id - a.id)[0];
            
            // Actualizar las variables de la interfaz de usuario con los datos de la última actualización
            this.acelerometro_roll = ultimaActualizacion.acelerometro_roll;
            this.acelerometro_pitch = ultimaActualizacion.acelerometro_pitch;
            this.acelerometro_yaw = ultimaActualizacion.acelerometro_yaw;
            
            this.giroscopio_pitch = ultimaActualizacion.giroscopio_pitch;
            this.giroscopio_roll = ultimaActualizacion.giroscopio_roll;
            this.giroscopio_yaw = ultimaActualizacion.giroscopio_yaw;

            this.humedad = ultimaActualizacion.humedad;
            this.presion = ultimaActualizacion.presion;
            this.temperatura = ultimaActualizacion.temperatura;

        },
        enviarMensajeMQTT() {
            const csrfToken = window.csrfToken;

            const message = {
                interface: 'send_aio'
            };
            // Enviar una solicitud POST al servidor Django
            axios.post('http://127.0.0.1:8000/sensar-mqtt/', message, {
                headers: {
                    'X-CSRFToken': csrfToken // Incluye el token CSRF en la cabecera de la solicitud
                }
            })
            .then(() => {
                console.log('Mensaje MQTT enviado correctamente');
                this.obtenerDatosSensores()
                this.obtenerUltimaActualizacion();
            })
            .catch(error => {
                console.error('Error al enviar mensaje MQTT:', error);
            });

        },
        
    },  

}

</script>



<style>

    .divider-style:before {
    content: "";
    display: block;
    border-top: solid 1px black;
    width: 100%;
    height: 1px;
    position: absolute;
    top: 50%;
    z-index: 1;
    }

    .divider-style {
    margin-top: 0px;
    position: relative;
    margin-right: 40px;
    margin-left: 40px;
    }

    .divider-style span {
    background: #fff;
    padding: 0 20px;
    position: relative;
    z-index: 5;
    }

    @media (min-width:768px) {
    .col-md-12 {
    flex: 0 0 auto;
    width: 100%;
  }
}

.row > * {
  flex-shrink: 0;
  width: 100%;
  max-width: 100%;
  padding-right: calc(var(--bs-gutter-x) * .5);
  padding-left: calc(var(--bs-gutter-x) * .5);
  margin-top: var(--bs-gutter-y);
}

.navbar {
  --bs-navbar-padding-x: 0;
  --bs-navbar-padding-y: 0.5rem;
  --bs-navbar-color: rgba(var(--bs-emphasis-color-rgb), 0.65);
  --bs-navbar-hover-color: rgba(var(--bs-emphasis-color-rgb), 0.8);
  --bs-navbar-disabled-color: rgba(var(--bs-emphasis-color-rgb), 0.3);
  --bs-navbar-active-color: rgba(var(--bs-emphasis-color-rgb), 1);
  --bs-navbar-brand-padding-y: 0.3125rem;
  --bs-navbar-brand-margin-end: 1rem;
  --bs-navbar-brand-font-size: 1.25rem;
  --bs-navbar-brand-color: rgba(var(--bs-emphasis-color-rgb), 1);
  --bs-navbar-brand-hover-color: rgba(var(--bs-emphasis-color-rgb), 1);
  --bs-navbar-nav-link-padding-x: 0.5rem;
  --bs-navbar-toggler-padding-y: 0.25rem;
  --bs-navbar-toggler-padding-x: 0.75rem;
  --bs-navbar-toggler-font-size: 1.25rem;
  --bs-navbar-toggler-icon-bg: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%2833, 37, 41, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
  --bs-navbar-toggler-border-color: rgba(var(--bs-emphasis-color-rgb), 0.15);
  --bs-navbar-toggler-border-radius: var(--bs-border-radius);
  --bs-navbar-toggler-focus-width: 0.25rem;
  --bs-navbar-toggler-transition: box-shadow 0.15s ease-in-out;
  position: relative;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  padding: var(--bs-navbar-padding-y) var(--bs-navbar-padding-x);
}





    


</style>